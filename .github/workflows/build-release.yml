name: Build and Release Vib-OS

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.5.0, v1.0.0, etc.
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Release version (e.g., v0.5.0)'
        required: true
        default: 'v0.5.0'

jobs:
  build-arm64:
    name: Build ARM64 Kernel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            qemu-system-arm \
            make \
            lld \
            llvm
      
      - name: Build ARM64 kernel
        run: |
          make clean
          make kernel
      
      - name: Create ARM64 bootable image
        run: |
          make image || echo "Image creation skipped (optional)"
      
      - name: Package ARM64 artifacts
        run: |
          mkdir -p release/arm64
          cp build/kernel/unixos.elf release/arm64/vibos-arm64.elf
          if [ -f image/unixos.img ]; then
            cp image/unixos.img release/arm64/vibos-arm64.img
          fi
          
          # Create checksums
          cd release/arm64
          sha256sum * > SHA256SUMS
          cd ../..
          
          # Create tarball
          tar -czf vibos-arm64.tar.gz -C release/arm64 .
      
      - name: Upload ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vibos-arm64
          path: vibos-arm64.tar.gz
          retention-days: 90

  build-x86_64:
    name: Build x86_64 Kernel
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc \
            binutils \
            qemu-system-x86 \
            make \
            lld \
            llvm \
            xorriso \
            grub-pc-bin \
            grub-efi-amd64-bin \
            mtools \
            dosfstools
      
      - name: Build x86_64 kernel
        run: |
          make -f Makefile.multiarch ARCH=x86_64 clean
          make -f Makefile.multiarch ARCH=x86_64 kernel
      
      - name: Create x86_64 bootable images
        run: |
          # Create UEFI image
          if [ -f scripts/create-uefi-image.sh ]; then
            chmod +x scripts/create-uefi-image.sh
            ./scripts/create-uefi-image.sh || echo "UEFI image creation skipped"
          fi
          
          # Create BIOS image
          if [ -f scripts/create-bios-image.sh ]; then
            chmod +x scripts/create-bios-image.sh
            ./scripts/create-bios-image.sh || echo "BIOS image creation skipped"
          fi
          
          # Create ISO
          if [ -f scripts/create-iso.sh ]; then
            chmod +x scripts/create-iso.sh
            ./scripts/create-iso.sh || echo "ISO creation skipped"
          fi
      
      - name: Package x86_64 artifacts
        run: |
          mkdir -p release/x86_64
          cp build/x86_64/kernel/vibos-x86_64.elf release/x86_64/
          
          # Copy bootable images if they exist
          [ -f vibos-uefi.img ] && cp vibos-uefi.img release/x86_64/
          [ -f vibos-bios.img ] && cp vibos-bios.img release/x86_64/
          [ -f vibos.iso ] && cp vibos.iso release/x86_64/
          
          # Create checksums
          cd release/x86_64
          sha256sum * > SHA256SUMS
          cd ../..
          
          # Create tarball
          tar -czf vibos-x86_64.tar.gz -C release/x86_64 .
      
      - name: Upload x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vibos-x86_64
          path: vibos-x86_64.tar.gz
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build-arm64, build-x86_64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: vibos-arm64
          path: ./artifacts
      
      - name: Download x86_64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: vibos-x86_64
          path: ./artifacts
      
      - name: Extract version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # Vib-OS ${{ steps.get_version.outputs.version }}
          
          A Unix-like operating system with multi-architecture support.
          
          ## ðŸŽ¯ Supported Architectures
          
          - âœ… **ARM64** - Raspberry Pi 4/5, ARM64 UEFI boards
          - âœ… **x86_64** - Modern PCs (UEFI and Legacy BIOS)
          
          ## ðŸ“¦ Downloads
          
          ### ARM64
          - `vibos-arm64.tar.gz` - ARM64 kernel and bootable image
            - `vibos-arm64.elf` - Kernel binary
            - `vibos-arm64.img` - Bootable SD card image (if available)
            - `SHA256SUMS` - Checksums for verification
          
          ### x86_64
          - `vibos-x86_64.tar.gz` - x86_64 kernel and bootable images
            - `vibos-x86_64.elf` - Kernel binary
            - `vibos-uefi.img` - UEFI bootable image (if available)
            - `vibos-bios.img` - Legacy BIOS bootable image (if available)
            - `vibos.iso` - Bootable ISO (if available)
            - `SHA256SUMS` - Checksums for verification
          
          ## ðŸš€ Quick Start
          
          ### For ARM64 (Raspberry Pi 4/5)
          ```bash
          # Extract the archive
          tar -xzf vibos-arm64.tar.gz
          
          # Write to SD card (replace /dev/sdX with your SD card device)
          sudo dd if=vibos-arm64.img of=/dev/sdX bs=4M status=progress
          sync
          
          # Insert SD card and boot
          ```
          
          ### For x86_64 PC (UEFI)
          ```bash
          # Extract the archive
          tar -xzf vibos-x86_64.tar.gz
          
          # Write to USB drive (replace /dev/sdX with your USB device)
          sudo dd if=vibos-uefi.img of=/dev/sdX bs=4M status=progress
          sync
          
          # Boot from USB (select UEFI boot in BIOS)
          ```
          
          ### For x86_64 PC (Legacy BIOS)
          ```bash
          # Extract the archive
          tar -xzf vibos-x86_64.tar.gz
          
          # Write to USB drive (replace /dev/sdX with your USB device)
          sudo dd if=vibos-bios.img of=/dev/sdX bs=4M status=progress
          sync
          
          # Boot from USB (select Legacy/BIOS boot)
          ```
          
          ### For x86_64 VM (ISO)
          ```bash
          # Extract the archive
          tar -xzf vibos-x86_64.tar.gz
          
          # Use vibos.iso with QEMU, VirtualBox, or VMware
          qemu-system-x86_64 -cdrom vibos.iso -m 2G
          ```
          
          ## âœ¨ Features
          
          - Multi-architecture support (ARM64, x86_64)
          - Virtual memory management (MMU/paging)
          - Process scheduling and context switching
          - Virtual File System (VFS) with RAMFS, EXT4, APFS support
          - Graphical User Interface (GUI) with window manager
          - Device drivers (PCI, USB, network, storage)
          - System calls and IPC
          - Media support (JPEG, MP3)
          
          ## ðŸ“š Documentation
          
          See the repository for detailed documentation:
          - `BUILD_ALL.md` - Build instructions
          - `MULTIARCH_QUICKSTART.md` - Quick reference
          - `MULTIARCH_COMPLETE.md` - Technical details
          - `docs/` - Additional documentation
          
          ## ðŸ”’ Verification
          
          Verify your downloads using SHA256:
          ```bash
          sha256sum -c SHA256SUMS
          ```
          
          ## âš ï¸ Disclaimer
          
          This is experimental software. Use at your own risk. Always backup your data before installing on real hardware.
          
          ## ðŸ“ Changelog
          
          See [CHANGELOG.md](CHANGELOG.md) for detailed changes in this release.
          EOF
          
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Vib-OS ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/vibos-arm64.tar.gz
            artifacts/vibos-x86_64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
